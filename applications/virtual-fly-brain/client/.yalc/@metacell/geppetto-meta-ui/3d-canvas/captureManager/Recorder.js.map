{"version":3,"file":"Recorder.js","names":["_utils","require","_typeof","o","Symbol","iterator","constructor","prototype","_classCallCheck","instance","Constructor","TypeError","_defineProperties","target","props","i","length","descriptor","enumerable","configurable","writable","Object","defineProperty","_toPropertyKey","key","_createClass","protoProps","staticProps","t","_toPrimitive","r","e","toPrimitive","call","String","Number","Recorder","exports","canvas","recorderOptions","stream","captureStream","mediaRecorderOptions","blobOptions","setupMediaRecorder","recordedBlobs","ctx","getContext","animationLoop","bind","value","handleDataAvailable","event","data","size","push","options","_this","mimeType","mediaRecorder","MediaRecorder","e0","console","log","e1","e2","alert","error","ondataavailable","evt","onstart","_options","type","startRecording","start","stopRecording","stop","getRecordingBlob","download","filename","concat","formatDate","Date","blob","url","window","URL","createObjectURL","a","document","createElement","style","display","href","body","appendChild","click","setTimeout","removeChild","revokeObjectURL","Blob","drawArrays","POINTS","state","requestAnimationFrame"],"sources":["../../../src/3d-canvas/captureManager/Recorder.js"],"sourcesContent":["import { formatDate } from \"./utils\";\n\nexport class Recorder {\n  constructor (canvas, recorderOptions) {\n    this.stream = canvas.captureStream();\n    const {mediaRecorderOptions, blobOptions} = recorderOptions\n    this.setupMediaRecorder(mediaRecorderOptions)\n    this.recordedBlobs = []\n    this.blobOptions = blobOptions\n    this.ctx = canvas.getContext('webgl')\n    this.animationLoop = this.animationLoop.bind(this)\n  }\n\n  handleDataAvailable (event) {\n    if (event.data && event.data.size > 0) {\n      this.recordedBlobs.push(event.data);\n    }\n  }\n\n  setupMediaRecorder (options){\n    if(options == null){\n      options = { mimeType: 'video/webm' };\n    }\n    let mediaRecorder;\n    try {\n      mediaRecorder = new MediaRecorder(this.stream, options);\n    } catch (e0) {\n      console.log('Unable to create MediaRecorder with options Object: ', e0);\n      try {\n        options = { mimeType: 'video/webm,codecs=vp9' };\n        mediaRecorder = new MediaRecorder(this.stream, options);\n      } catch (e1) {\n        console.log('Unable to create MediaRecorder with options Object: ', e1);\n        try {\n          options = { mimeType: 'video/webm,codecs=vp8' }; // Chrome 47\n          mediaRecorder = new MediaRecorder(this.stream, options);\n        } catch (e2) {\n          alert('MediaRecorder is not supported by this browser.\\n\\n'\n              + 'Try Firefox 29 or later, or Chrome 47 or later, '\n              + 'with Enable experimental Web Platform features enabled from chrome://flags.');\n          console.error('Exception while creating MediaRecorder:', e2);\n          return;\n        }\n      }\n    }\n    mediaRecorder.ondataavailable = evt => this.handleDataAvailable(evt);\n    mediaRecorder.onstart = () => this.animationLoop();\n\n    this.mediaRecorder = mediaRecorder\n    this.options = options\n    if(!this.blobOptions){\n      const {mimeType} = options\n      this.blobOptions = {type: mimeType}\n    }\n  }\n\n  startRecording (){\n    this.recordedBlobs = []\n    this.mediaRecorder.start(100);\n  }\n\n  stopRecording (options){\n    this.mediaRecorder.stop();\n    return this.getRecordingBlob(options)\n  }\n\n  download (filename, options){\n    if (!filename){\n      filename = `CanvasRecording_${formatDate(new Date())}.webm`\n    }\n    const blob = this.getRecordingBlob(options)\n    const url = window.URL.createObjectURL(blob);\n    const a = document.createElement('a');\n    a.style.display = 'none';\n    a.href = url;\n    a.download = filename;\n    document.body.appendChild(a);\n    a.click();\n    setTimeout(() => {\n      document.body.removeChild(a);\n      window.URL.revokeObjectURL(url);\n    }, 100);\n    return blob\n  }\n\n  getRecordingBlob (options){\n    if(!options){\n      options = this.blobOptions\n    }\n    return new Blob(this.recordedBlobs, options);\n  }\n\n  animationLoop() {\n    // draw nothing, but still draw\n    this.ctx.drawArrays(this.ctx.POINTS, 0, 0)\n    if (this.mediaRecorder.state !== \"inactive\") {\n      requestAnimationFrame(this.animationLoop);\n    }\n  }\n}"],"mappings":"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","ignoreList":[]}