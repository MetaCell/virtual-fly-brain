{"version":3,"file":"reducer.js","names":["layout","state","layoutInitialState","action","type","layoutActions","SET_LAYOUT","data","UPDATE_LAYOUT","toJson","General","IMPORT_APPLICATION_STATE","incomingState","redux","updateWidgetStatus","widgets","status","panelName","WidgetStatus","ACTIVE","Object","fromEntries","values","filter","widget","map","id","HIDDEN","removeUndefined","obj","keys","forEach","key","undefined","extractPanelName","component","ADD_WIDGET","ACTIVATE_WIDGET","UPDATE_WIDGET","newWidget","SET_WIDGETS","ADD_WIDGETS","REMOVE_WIDGET","DESTROY_WIDGET","newWidgets","model","updatedWidgets","parents","Set","widgetId","getNodeById","n","getParent","parent","i","getChildren","node","getId","name","getName","getType","pos","parseInt","isMaximized","isVisible","MAXIMIZED","MINIMIZED","getSelectedNode"],"sources":["../../../src/common/layout/reducer.ts"],"sourcesContent":["import * as FlexLayout from '@metacell/geppetto-meta-ui/flex-layout/src/index';\nimport { layoutActions } from './actions';\nimport * as General from '../actions';\nimport { WidgetStatus, WidgetMap, ExtendedNode } from './model'\nimport layoutInitialState from './defaultLayout';\nexport { layoutInitialState };\n\nexport interface LayoutState {\n  global: {\n    sideBorders: number,\n    tabSetHeaderHeight: number,\n    tabSetTabStripHeight: number,\n    enableEdgeDock: Boolean,\n    borderBarSize: number\n  },\n  borders: {\n    type: string,\n    location: string,\n    children: ExtendedNode[]\n  }[],\n  layout: {\n    type: string,\n    weight: number,\n    id: string,\n    children: ExtendedNode[]\n  }\n}\n\n/**\n * Layout state update handling.\n * Logic comes from the layout manager.\n * \n * @alias layoutReducer\n * @memberof Control\n */\nexport const layout = (state = layoutInitialState, action) => {\n\n  switch (action.type) {\n\n  case layoutActions.SET_LAYOUT: {\n    return { ...state, ...action.data }\n  }\n  case layoutActions.UPDATE_LAYOUT: {\n    return { ...state, ...action.data.toJson() }\n  }\n\n  case General.IMPORT_APPLICATION_STATE: {\n    const incomingState = action.data.redux.layout;\n    return incomingState;\n  }\n  default:\n    return state\n  }\n}\n\n/**\n * Ensure there is one only active widget in the same panel\n * @param {*} widgets \n * @param {*} param1 \n */\nfunction updateWidgetStatus (widgets: WidgetMap, { status, panelName }) {\n  if (status != WidgetStatus.ACTIVE) {\n    return widgets;\n  }\n  return Object.fromEntries(Object.values(widgets).filter(widget => widget).map(widget => [\n    widget.id,\n    {\n      ...widget,\n      status: widget.panelName == panelName ? WidgetStatus.HIDDEN : widget.status\n    }\n  ]));\n}\n\nfunction removeUndefined (obj) {\n  return Object.keys(obj).forEach(key => obj[key] === undefined ? delete obj[key] : '');\n}\n\nfunction extractPanelName (action) {\n  return action.data.component == \"Plot\" ? \"bottomPanel\" : \"leftPanel\";\n}\n\nexport const widgets = (state: WidgetMap = {}, action) => {\n\n  if (action.data) {\n    removeUndefined(action.data); // Prevent deletion in case of unpolished update action\n  }\n\n  switch (action.type) {\n\n  case layoutActions.ADD_WIDGET:\n  case layoutActions.ACTIVATE_WIDGET:\n  case layoutActions.UPDATE_WIDGET: {\n    const newWidget = { ...state[action.data.id], panelName: extractPanelName(action), ...action.data };\n    return {\n      ...updateWidgetStatus(state, newWidget),\n      [action.data.id]: newWidget\n    }\n  }\n  case layoutActions.SET_WIDGETS: {\n    return { ...action.data }\n  }\n  case layoutActions.ADD_WIDGETS: {\n    return { ...state, ...action.data }\n  }\n\n  case layoutActions.REMOVE_WIDGET:\n  case layoutActions.DESTROY_WIDGET: {\n    const newWidgets = { ...state };\n    delete newWidgets[action.data.id];\n    return newWidgets;\n  }\n  case layoutActions.UPDATE_LAYOUT: {\n    const model: FlexLayout.Model = action.data;\n    const updatedWidgets = { ...state };\n    const parents = new Set(Object.keys(updatedWidgets).map(widgetId => model.getNodeById(widgetId)).filter(n => n).map(n => n?.getParent()));\n    for (const parent of parents) {\n      for (const i in parent.getChildren()) {\n        const node = parent.getChildren()[i];\n        if (!updatedWidgets[node.getId()]) {\n          continue;\n        }\n        updatedWidgets[node.getId()] = { ... updatedWidgets[node.getId()] };\n        updatedWidgets[node.getId()].name = node.getName()\n        if (parent.getType() !== 'border') {\n          // want to restore previous position when activated\n          updatedWidgets[node.getId()].pos = parseInt(i)\n        }\n\n        updatedWidgets[node.getId()].panelName = parent.getId(); \n        if (parent.isMaximized() && node.isVisible()) {\n          updatedWidgets[node.getId()].status = WidgetStatus.MAXIMIZED;\n        } else if (parent.getType() === 'border') {\n          updatedWidgets[node.getId()].status = WidgetStatus.MINIMIZED;\n        } else if (parent.getSelectedNode().getId() == node.getId()) {\n          updatedWidgets[node.getId()].status = WidgetStatus.ACTIVE;\n        } else {\n          updatedWidgets[node.getId()].status = WidgetStatus.HIDDEN;\n        }\n      }\n    }\n\n    return updatedWidgets\n  }\n\n  default:\n    return state;\n  }\n}\n\n"],"mappings":"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"}